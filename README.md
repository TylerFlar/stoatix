# Stoatix

A lightweight CLI tool for system benchmarking and diagnostics.

## Quickstart

```bash
# Clone the repository
git clone https://github.com/TylerFlar/stoatix.git
cd stoatix

# Install dependencies
uv sync

# Validate a configuration file
uv run stoatix validate examples/stoatix.yaml

# Dry run (validate + write metadata without executing)
uv run stoatix run examples/stoatix.yaml --dry-run

# Run benchmarks
uv run stoatix run examples/stoatix.yaml --out out/

# Run with shuffle (randomized case order)
uv run stoatix run examples/stoatix.yaml --shuffle --seed 12345
```

## Results

After running benchmarks, results are written to the output directory:

- **`out/session.json`** — Metadata about the run including suite ID, config hash, system info, and git info
- **`out/config.resolved.yml`** — Resolved configuration with all defaults expanded
- **`out/cases.json`** — Expanded cases in execution order
- **`out/results.jsonl`** — One JSON record per benchmark attempt with timing data
- **`out/summary.csv`** — Aggregated statistics per case (generated by default)

## Summary Statistics

By default, `stoatix run` generates `summary.csv` with per-case statistics.

### Record Selection

- **Only `measured` runs** are included (warmups are excluded)
- **Retry handling**: For each (case_id, iteration), the **first successful attempt** (`ok=true`) is used. If all attempts failed, that iteration is counted as failed and excluded from timing stats.

### Outlier Filtering

| Method | Description |
|--------|-------------|
| `iqr` (default) | Per-case IQR filtering: values outside [Q1 - 1.5×IQR, Q3 + 1.5×IQR] are dropped |
| `none` | Keep all successful elapsed times |

Use `--outliers none` or `--outliers iqr` to control this behavior.

### Statistics Definitions

| Statistic | Definition |
|-----------|------------|
| `median_s` | Median of filtered elapsed times |
| `mean_s` | Arithmetic mean of filtered elapsed times |
| `stdev_s` | Sample standard deviation (ddof=1); blank if n < 2 |
| `p95_s` | 95th percentile using linear interpolation between adjacent sorted values |
| `min_s`, `max_s` | Min/max of filtered elapsed times |

### Standalone Summarization

```bash
# Summarize existing results
uv run stoatix summarize out/results.jsonl

# Specify output path and outlier method
uv run stoatix summarize out/results.jsonl --out report.csv --outliers none
```

## Configuration

Create a YAML file with your benchmarks:

```yaml
# Optional defaults applied to all benchmarks
defaults:
  warmups: 2
  runs: 5
  retries: 0
  timeout_s: 60.0
  env:
    MY_VAR: "value"

benchmarks:
  - name: my-benchmark
    command: ["python", "-c", "print('hello')"]
    warmups: 1      # warmup iterations (not measured)
    runs: 5         # measured iterations
    timeout_s: 10.0 # optional timeout in seconds

  # Matrix expansion example
  - name: parameterized-bench
    command: ["python", "-c", "print({n})"]
    matrix:
      n: [100, 1000, 10000]
```

The `command` must be a list of strings (exec form, no shell).

## CLI Reference

```bash
# Show help
uv run stoatix --help

# Show version
uv run stoatix --version

# Validate config without running
uv run stoatix validate <config.yaml>

# Run benchmarks
uv run stoatix run <config.yaml> [OPTIONS]

# Run command options:
#   --out, -o PATH       Output directory (default: out)
#   --shuffle            Shuffle case execution order
#   --no-shuffle         Preserve deterministic order (default)
#   --seed INTEGER       Random seed for shuffling
#   --dry-run            Write metadata files without executing benchmarks
#   --summarize          Generate summary.csv after run (default)
#   --no-summarize       Skip summary generation
#   --outliers TEXT      Outlier filtering: 'iqr' (default) or 'none'

# Summarize existing results
uv run stoatix summarize <results.jsonl> [OPTIONS]

# Summarize command options:
#   --out, -o PATH       Output CSV path (default: summary.csv in same dir)
#   --outliers TEXT      Outlier filtering: 'iqr' (default) or 'none'

# Examples:
uv run stoatix run config.yaml --out results/
uv run stoatix run config.yaml --shuffle --seed 42
uv run stoatix run config.yaml --no-summarize
uv run stoatix run config.yaml --outliers none
uv run stoatix summarize out/results.jsonl --out report.csv
```

## License

MIT
